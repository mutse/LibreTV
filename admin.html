<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreTV ç®¡ç†é¢æ¿</title>
    <script src="libs/tailwindcss.min.js"></script>
    <style>
        .admin-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }
        .content-area {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .table-row:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .hidden { display: none; }
        
        /* Toggle switch styles */
        .toggle-bg {
            transition: background-color 0.3s ease-in-out;
            background-color: #6b7280; /* é»˜è®¤ç°è‰²èƒŒæ™¯ */
        }
        .toggle-dot {
            transition: transform 0.3s ease-in-out;
        }
        #yellowFilterToggle:checked + .toggle-bg {
            background-color: #667eea;
        }
        #yellowFilterToggle:checked ~ .toggle-dot {
            transform: translateX(1.5rem);
        }
        #yellowFilterToggle:focus + .toggle-bg,
        #yellowFilterToggle:hover + .toggle-bg {
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        #adFilterToggle:checked + .toggle-bg {
            background-color: #667eea;
        }
        #adFilterToggle:checked ~ .toggle-dot {
            transform: translateX(1.5rem);
        }
        #adFilterToggle:focus + .toggle-bg,
        #adFilterToggle:hover + .toggle-bg {
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        #doubanToggle:checked + .toggle-bg {
            background-color: #667eea;
        }
        #doubanToggle:checked ~ .toggle-dot {
            transform: translateX(1.5rem);
        }
        #doubanToggle:focus + .toggle-bg,
        #doubanToggle:hover + .toggle-bg {
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        .filter-disabled .toggle-bg {
            background-color: #444 !important;
            opacity: 0.8;
        }
        .filter-disabled .toggle-dot {
            transform: translateX(0) !important;
            opacity: 0.8;
        }
    </style>
</head>
<body class="font-sans">
    <div class="admin-container flex">
        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="card rounded-lg p-8 w-96">
                <h2 class="text-2xl font-bold text-white mb-6 text-center">ç®¡ç†å‘˜ç™»å½•</h2>
                <form id="loginForm">
                    <div class="mb-4">
                        <label class="block text-white text-sm font-bold mb-2">ç®¡ç†å‘˜å¯†ç </label>
                        <input type="password" id="adminPassword" class="w-full px-3 py-2 bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 rounded focus:outline-none focus:border-opacity-60" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " required>
                    </div>
                    <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded">
                        ç™»å½•
                    </button>
                </form>
                <div id="loginError" class="text-red-300 text-sm mt-4 hidden"></div>
            </div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar" class="sidebar w-64 p-6 hidden">
            <div class="text-white">
                <h1 class="text-2xl font-bold mb-8">LibreTV ç®¡ç†</h1>
                <nav class="space-y-2">
                    <a href="#" onclick="showSection('dashboard')" class="nav-item block px-4 py-3 text-white hover:bg-white hover:bg-opacity-20 rounded">
                        ğŸ“Š ä»ªè¡¨æ¿
                    </a>
                    <a href="#" onclick="showSection('users')" class="nav-item block px-4 py-3 text-white hover:bg-white hover:bg-opacity-20 rounded">
                        ğŸ‘¥ ç”¨æˆ·ç®¡ç†
                    </a>
                    <a href="#" onclick="showSection('settings')" class="nav-item block px-4 py-3 text-white hover:bg-white hover:bg-opacity-20 rounded">
                        âš™ï¸ ç³»ç»Ÿè®¾ç½®
                    </a>
                    <a href="#" onclick="logout()" class="nav-item block px-4 py-3 text-red-300 hover:bg-red-500 hover:bg-opacity-20 rounded">
                        ğŸšª é€€å‡ºç™»å½•
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="flex-1 p-6 hidden">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section">
                <h2 class="text-3xl font-bold text-white mb-8">ä»ªè¡¨æ¿</h2>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-white">æ€»ç”¨æˆ·æ•°</h3>
                                <p id="totalUsers" class="text-2xl font-bold text-white">-</p>
                            </div>
                            <div class="text-4xl text-white opacity-60">ğŸ‘¥</div>
                        </div>
                    </div>
                    
                    <div class="card rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-white">ä»Šæ—¥æ–°ç”¨æˆ·</h3>
                                <p id="newUsersToday" class="text-2xl font-bold text-white">-</p>
                            </div>
                            <div class="text-4xl text-white opacity-60">ğŸ†•</div>
                        </div>
                    </div>
                    
                    <div class="card rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-white">æ´»è·ƒè®¢é˜…</h3>
                                <p id="activeSubscriptions" class="text-2xl font-bold text-white">-</p>
                            </div>
                            <div class="text-4xl text-white opacity-60">âœ…</div>
                        </div>
                    </div>
                    
                    <div class="card rounded-lg p-6">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-white">æ€»æ”¶å…¥</h3>
                                <p id="totalRevenue" class="text-2xl font-bold text-white">-</p>
                            </div>
                            <div class="text-4xl text-white opacity-60">ğŸ’°</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="section hidden">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-white">ç”¨æˆ·ç®¡ç†</h2>
                    <div class="flex space-x-4">
                        <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·..." class="px-4 py-2 bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 rounded focus:outline-none focus:border-opacity-60">
                        <button onclick="searchUsers()" class="btn-primary text-white px-6 py-2 rounded">æœç´¢</button>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-white">
                            <thead class="bg-white bg-opacity-10">
                                <tr>
                                    <th class="px-6 py-3 text-left">ç”¨æˆ·ID</th>
                                    <th class="px-6 py-3 text-left">ç”¨æˆ·å</th>
                                    <th class="px-6 py-3 text-left">é‚®ç®±</th>
                                    <th class="px-6 py-3 text-left">è®¢é˜…çŠ¶æ€</th>
                                    <th class="px-6 py-3 text-left">æ³¨å†Œæ—¶é—´</th>
                                    <th class="px-6 py-3 text-left">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="flex justify-between items-center mt-6">
                    <div class="text-white" id="paginationInfo">
                        æ˜¾ç¤º 0 - 0 å…± 0 ç”¨æˆ·
                    </div>
                    <div class="flex space-x-2" id="paginationControls">
                        <!-- Dynamic pagination buttons -->
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="section hidden">
                <h2 class="text-3xl font-bold text-white mb-8">ç³»ç»Ÿè®¾ç½®</h2>
                
                <div class="space-y-6">
                    <!-- æ•°æ®æºè®¾ç½®åŒºåŸŸ -->
                    <div class="card p-6 rounded-lg">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-white border-opacity-20 pb-2">æ•°æ®æºè®¾ç½®</h3>
                        
                        <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                        <div class="flex space-x-2 mb-4">
                            <button onclick="selectAllAPIs(true)" class="px-3 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white text-sm rounded">å…¨é€‰</button>
                            <button onclick="selectAllAPIs(false)" class="px-3 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white text-sm rounded">å…¨ä¸é€‰</button>
                            <button onclick="selectAllAPIs(true, true)" class="px-3 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white text-sm rounded">å…¨é€‰æ™®é€šèµ„æº</button>
                        </div>
                        
                        <!-- APIé€‰æ‹©åŒºåŸŸ -->
                        <div class="max-h-48 overflow-y-auto bg-white bg-opacity-10 p-4 rounded-lg mb-4">
                            <div id="apiCheckboxes">
                                <!-- è¿™é‡Œå°†åŠ¨æ€æ’å…¥APIå¤é€‰æ¡† -->
                            </div>
                        </div>
                        
                        <!-- APIä¿¡æ¯æ˜¾ç¤º -->
                        <div class="text-sm text-gray-300 flex justify-between items-center">
                            <span>å·²é€‰APIæ•°é‡ï¼š<span id="selectedApiCount" class="text-white font-semibold">0</span></span>
                            <span id="siteStatus" class="ml-2"></span>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰APIç®¡ç†åŒºåŸŸ -->
                    <div class="card p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white border-b border-white border-opacity-20 pb-2 flex-1">è‡ªå®šä¹‰API</h3>
                            <button onclick="showAddCustomApiForm()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white w-8 h-8 rounded-full text-center text-lg ml-2">+</button>
                        </div>
                        <div id="customApisList" class="max-h-40 overflow-y-auto mb-4">
                            <!-- è‡ªå®šä¹‰APIå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                        
                        <!-- æ·»åŠ è‡ªå®šä¹‰APIè¡¨å• (é»˜è®¤éšè—) -->
                        <div id="addCustomApiForm" class="hidden mt-4 p-4 bg-white bg-opacity-10 rounded-lg">
                            <input type="text" id="customApiName" placeholder="APIåç§°" class="w-full bg-white bg-opacity-20 border border-white border-opacity-30 text-white px-3 py-2 rounded mb-3" autocomplete="off">
                            <input type="text" id="customApiUrl" placeholder="https://abc.com" class="w-full bg-white bg-opacity-20 border border-white border-opacity-30 text-white px-3 py-2 rounded mb-3" autocomplete="off">
                            <input type="text" id="customApiDetail" placeholder="detailåœ°å€ï¼ˆå¯é€‰ï¼‰" class="w-full bg-white bg-opacity-20 border border-white border-opacity-30 text-white px-3 py-2 rounded mb-3" autocomplete="off">
                            <div class="flex items-center mb-3">
                                <input type="checkbox" id="customApiIsAdult" class="form-checkbox h-4 w-4 text-pink-500">
                                <label for="customApiIsAdult" class="ml-2 text-sm text-pink-300">é»„è‰²èµ„æºç«™</label>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="addCustomApi()" class="btn-primary text-white px-4 py-2 rounded text-sm">æ·»åŠ </button>
                                <button onclick="cancelAddCustomApi()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å†…å®¹è¿‡æ»¤è®¾ç½®åŒºåŸŸ -->
                    <div class="card p-6 rounded-lg">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-white border-opacity-20 pb-2">åŠŸèƒ½å¼€å…³</h3>
                        
                        <!-- é»„è‰²å†…å®¹è¿‡æ»¤å¼€å…³ -->
                        <div class="flex items-center justify-between mb-6 pb-4 border-b border-white border-opacity-10">
                            <div>
                                <label class="text-lg font-medium text-white">é»„è‰²å†…å®¹è¿‡æ»¤</label>
                                <p class="text-sm text-gray-300 mt-1">è¿‡æ»¤"ä¼¦ç†ç‰‡"ç­‰é»„è‰²å†…å®¹</p>
                            </div>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" id="yellowFilterToggle" class="opacity-0 absolute w-full h-full cursor-pointer z-10">
                                <div class="toggle-bg w-12 h-6 rounded-full transition-colors duration-300 ease-in-out"></div>
                                <div class="toggle-dot absolute w-5 h-5 bg-white rounded-full top-0.5 left-0.5 transition-transform duration-300 ease-in-out"></div>
                            </div>
                        </div>
                        
                        <!-- å¹¿å‘Šè¿‡æ»¤å¼€å…³ -->
                        <div class="flex items-center justify-between mb-6 pb-4 border-b border-white border-opacity-10">
                            <div>
                                <label class="text-lg font-medium text-white">åˆ†ç‰‡å¹¿å‘Šè¿‡æ»¤</label>
                                <p class="text-sm text-gray-300 mt-1">å…³é—­å¯å‡å°‘æ—§ç‰ˆæµè§ˆå™¨å¡é¡¿</p>
                            </div>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" id="adFilterToggle" class="opacity-0 absolute w-full h-full cursor-pointer z-10">
                                <div class="toggle-bg w-12 h-6 rounded-full transition-colors duration-300 ease-in-out"></div>
                                <div class="toggle-dot absolute w-5 h-5 bg-white rounded-full top-0.5 left-0.5 transition-transform duration-300 ease-in-out"></div>
                            </div>
                        </div>
                        
                        <!-- è±†ç“£çƒ­é—¨å¼€å…³ -->
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-lg font-medium text-white">è±†ç“£çƒ­é—¨æ¨è</label>
                                <p class="text-sm text-gray-300 mt-1">é¦–é¡µæ˜¾ç¤ºè±†ç“£çƒ­é—¨å½±è§†å†…å®¹</p>
                            </div>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" id="doubanToggle" class="opacity-0 absolute w-full h-full cursor-pointer z-10">
                                <div class="toggle-bg w-12 h-6 rounded-full transition-colors duration-300 ease-in-out"></div>
                                <div class="toggle-dot absolute w-5 h-5 bg-white rounded-full top-0.5 left-0.5 transition-transform duration-300 ease-in-out"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸€èˆ¬åŠŸèƒ½åŒºåŸŸ -->
                    <div class="card p-6 rounded-lg">
                        <h3 class="text-xl font-semibold text-white mb-4 border-b border-white border-opacity-20 pb-2">ä¸€èˆ¬åŠŸèƒ½</h3>
                        <div class="space-y-3">
                            <button onclick="importConfig()" class="w-full btn-primary text-white py-3 px-4 rounded-lg text-sm font-medium">å¯¼å…¥é…ç½®</button>
                            <button onclick="exportConfig()" class="w-full btn-primary text-white py-3 px-4 rounded-lg text-sm font-medium">å¯¼å‡ºé…ç½®</button>
                            <button onclick="clearLocalStorage()" class="w-full btn-primary text-white py-3 px-4 rounded-lg text-sm font-medium">æ¸…é™¤Cookie</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div id="userDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="card rounded-lg p-8 w-2xl max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">ç”¨æˆ·è¯¦æƒ…</h2>
                <button onclick="closeUserDetail()" class="text-white hover:text-gray-300">âœ•</button>
            </div>
            <div id="userDetailContent">
                <!-- Dynamic user detail content -->
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="card rounded-lg p-8 w-96">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">ä¿®æ”¹è®¢é˜…</h2>
                <button onclick="closeSubscriptionModal()" class="text-white hover:text-gray-300">âœ•</button>
            </div>
            <form id="subscriptionForm">
                <input type="hidden" id="subscriptionUserId">
                <div class="mb-4">
                    <label class="block text-white text-sm font-bold mb-2">è®¢é˜…è®¡åˆ’</label>
                    <select id="subscriptionPlan" class="w-full px-3 py-2 bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded focus:outline-none focus:border-opacity-60">
                        <option value="1">æœˆåº¦è®¢é˜…</option>
                        <option value="2">å¹´åº¦è®¢é˜…</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-white text-sm font-bold mb-2">ç»“æŸæ—¥æœŸ</label>
                    <input type="datetime-local" id="subscriptionEndDate" class="w-full px-3 py-2 bg-white bg-opacity-20 text-white border border-white border-opacity-30 rounded focus:outline-none focus:border-opacity-60" required>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 btn-primary text-white font-bold py-3 px-4 rounded">
                        æ›´æ–°è®¢é˜…
                    </button>
                    <button type="button" onclick="cancelSubscription()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded">
                        å–æ¶ˆè®¢é˜…
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let adminToken = localStorage.getItem('adminToken');
        let currentPage = 1;
        let currentUserId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (adminToken) {
                showDashboard();
            } else {
                showLogin();
            }
        });

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            try {
                console.log('Attempting admin login...');
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                console.log('Login response status:', response.status);
                const data = await response.json();
                console.log('Login response data:', data);
                
                if (data.success) {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    console.log('Login successful, showing dashboard');
                    showDashboard();
                } else {
                    console.error('Login failed:', data.error);
                    showError('loginError', data.error || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('Login request failed:', error);
                showError('loginError', 'ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥');
            }
        });

        function showLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            showSection('dashboard');
            loadDashboardStats();
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // Navigation
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-white', 'bg-opacity-20');
            });
            
            if (section === 'users') {
                loadUsers();
            } else if (section === 'settings') {
                loadSettings();
            }
        }

        // Dashboard functions
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/admin/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalUsers').textContent = stats.users.total;
                    document.getElementById('newUsersToday').textContent = stats.users.newToday;
                    document.getElementById('activeSubscriptions').textContent = stats.subscriptions.active;
                    document.getElementById('totalRevenue').textContent = 'Â¥' + (stats.revenue.total || 0);
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // Users functions
        async function loadUsers(page = 1, search = '') {
            try {
                console.log('Loading users, page:', page, 'search:', search);
                const response = await fetch(`/api/admin/users?page=${page}&limit=20&search=${encodeURIComponent(search)}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Users data received:', data);
                    renderUsersTable(data.users);
                    renderPagination(data.pagination);
                    currentPage = page;
                } else if (response.status === 401) {
                    console.log('Unauthorized, logging out');
                    logout();
                } else {
                    const errorData = await response.json();
                    console.error('Error response:', errorData);
                    alert('åŠ è½½ç”¨æˆ·å¤±è´¥: ' + (errorData.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥');
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = users.map(user => `
                <tr class="table-row border-b border-white border-opacity-10">
                    <td class="px-6 py-4">${user.id}</td>
                    <td class="px-6 py-4">${user.username}</td>
                    <td class="px-6 py-4">${user.email}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs ${user.subscription_status === 'active' ? 'bg-green-600' : 'bg-red-600'}">
                            ${user.subscription_status === 'active' ? 'æœ‰æ•ˆè®¢é˜…' : 'æ— è®¢é˜…'}
                        </span>
                    </td>
                    <td class="px-6 py-4">${new Date(user.created_at).toLocaleDateString('zh-CN')}</td>
                    <td class="px-6 py-4">
                        <button onclick="showUserDetail(${user.id})" class="text-blue-300 hover:text-blue-200 mr-2">è¯¦æƒ…</button>
                        <button onclick="showSubscriptionModal(${user.id})" class="text-green-300 hover:text-green-200 mr-2">è®¢é˜…</button>
                        <button onclick="deleteUser(${user.id})" class="text-red-300 hover:text-red-200">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination(pagination) {
            const info = document.getElementById('paginationInfo');
            const controls = document.getElementById('paginationControls');
            
            const start = (pagination.current - 1) * pagination.limit + 1;
            const end = Math.min(pagination.current * pagination.limit, pagination.totalUsers);
            info.textContent = `æ˜¾ç¤º ${start} - ${end} å…± ${pagination.totalUsers} ç”¨æˆ·`;
            
            let paginationHTML = '';
            
            // Previous button
            if (pagination.current > 1) {
                paginationHTML += `<button onclick="loadUsers(${pagination.current - 1})" class="px-3 py-1 bg-white bg-opacity-20 text-white rounded hover:bg-opacity-30">ä¸Šä¸€é¡µ</button>`;
            }
            
            // Page numbers
            for (let i = Math.max(1, pagination.current - 2); i <= Math.min(pagination.total, pagination.current + 2); i++) {
                const isActive = i === pagination.current;
                paginationHTML += `<button onclick="loadUsers(${i})" class="px-3 py-1 ${isActive ? 'bg-blue-600' : 'bg-white bg-opacity-20'} text-white rounded hover:bg-opacity-30">${i}</button>`;
            }
            
            // Next button
            if (pagination.current < pagination.total) {
                paginationHTML += `<button onclick="loadUsers(${pagination.current + 1})" class="px-3 py-1 bg-white bg-opacity-20 text-white rounded hover:bg-opacity-30">ä¸‹ä¸€é¡µ</button>`;
            }
            
            controls.innerHTML = paginationHTML;
        }

        function searchUsers() {
            const search = document.getElementById('userSearch').value;
            loadUsers(1, search);
        }

        // User detail functions
        async function showUserDetail(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderUserDetail(data.user, data.subscriptionHistory);
                    document.getElementById('userDetailModal').classList.remove('hidden');
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        function renderUserDetail(user, subscriptionHistory) {
            const content = document.getElementById('userDetailContent');
            content.innerHTML = `
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4">åŸºæœ¬ä¿¡æ¯</h3>
                        <div class="grid grid-cols-2 gap-4 text-white">
                            <div><strong>ç”¨æˆ·ID:</strong> ${user.id}</div>
                            <div><strong>ç”¨æˆ·å:</strong> ${user.username}</div>
                            <div><strong>é‚®ç®±:</strong> ${user.email}</div>
                            <div><strong>æ³¨å†Œæ—¶é—´:</strong> ${new Date(user.created_at).toLocaleString('zh-CN')}</div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4">å½“å‰è®¢é˜…</h3>
                        <div class="text-white">
                            ${user.plan_name ? `
                                <div class="grid grid-cols-2 gap-4">
                                    <div><strong>è®¡åˆ’:</strong> ${user.plan_name}</div>
                                    <div><strong>ä»·æ ¼:</strong> Â¥${user.price}</div>
                                    <div><strong>å¼€å§‹æ—¶é—´:</strong> ${new Date(user.subscription_start).toLocaleString('zh-CN')}</div>
                                    <div><strong>ç»“æŸæ—¶é—´:</strong> ${new Date(user.subscription_end).toLocaleString('zh-CN')}</div>
                                </div>
                            ` : '<p>æ— æ´»è·ƒè®¢é˜…</p>'}
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4">è®¢é˜…å†å²</h3>
                        <div class="max-h-40 overflow-y-auto">
                            ${subscriptionHistory.length > 0 ? `
                                <table class="w-full text-white text-sm">
                                    <thead>
                                        <tr class="border-b border-white border-opacity-20">
                                            <th class="text-left py-2">è®¡åˆ’</th>
                                            <th class="text-left py-2">çŠ¶æ€</th>
                                            <th class="text-left py-2">å¼€å§‹æ—¶é—´</th>
                                            <th class="text-left py-2">ç»“æŸæ—¶é—´</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${subscriptionHistory.map(sub => `
                                            <tr class="border-b border-white border-opacity-10">
                                                <td class="py-2">${sub.plan_name}</td>
                                                <td class="py-2">
                                                    <span class="px-2 py-1 rounded text-xs ${sub.status === 'active' ? 'bg-green-600' : 'bg-red-600'}">
                                                        ${sub.status}
                                                    </span>
                                                </td>
                                                <td class="py-2">${new Date(sub.start_date).toLocaleDateString('zh-CN')}</td>
                                                <td class="py-2">${new Date(sub.end_date).toLocaleDateString('zh-CN')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p>æ— è®¢é˜…å†å²</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function closeUserDetail() {
            document.getElementById('userDetailModal').classList.add('hidden');
        }

        // Subscription functions
        function showSubscriptionModal(userId) {
            currentUserId = userId;
            document.getElementById('subscriptionUserId').value = userId;
            document.getElementById('subscriptionModal').classList.remove('hidden');
            
            // Set default end date to 1 month from now
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('subscriptionEndDate').value = nextMonth.toISOString().slice(0, 16);
        }

        function closeSubscriptionModal() {
            document.getElementById('subscriptionModal').classList.add('hidden');
            currentUserId = null;
        }

        document.getElementById('subscriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const planId = document.getElementById('subscriptionPlan').value;
            const endDate = document.getElementById('subscriptionEndDate').value;
            
            try {
                const response = await fetch(`/api/admin/users/${currentUserId}/subscription`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        planId,
                        endDate: new Date(endDate).toISOString()
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    closeSubscriptionModal();
                    loadUsers(currentPage);
                    alert('è®¢é˜…æ›´æ–°æˆåŠŸ');
                } else {
                    alert(data.error || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                alert('æ›´æ–°è®¢é˜…å¤±è´¥');
            }
        });

        async function cancelSubscription() {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆç”¨æˆ·çš„è®¢é˜…å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/users/${currentUserId}/subscription`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    closeSubscriptionModal();
                    loadUsers(currentPage);
                    alert('è®¢é˜…å·²å–æ¶ˆ');
                } else {
                    alert(data.error || 'å–æ¶ˆå¤±è´¥');
                }
            } catch (error) {
                alert('å–æ¶ˆè®¢é˜…å¤±è´¥');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    loadUsers(currentPage);
                    alert('ç”¨æˆ·å·²åˆ é™¤');
                } else {
                    alert(data.error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤ç”¨æˆ·å¤±è´¥');
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/admin/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('adminToken');
            adminToken = null;
            showLogin();
        }

        // Enter key search
        document.getElementById('userSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });

        // Settings functions
        function loadSettings() {
            // åˆå§‹åŒ–APIå¤é€‰æ¡†
            initAPICheckboxes();
            
            // åˆå§‹åŒ–è‡ªå®šä¹‰APIåˆ—è¡¨
            renderCustomAPIsList();
            
            // åˆå§‹åŒ–æ˜¾ç¤ºé€‰ä¸­çš„APIæ•°é‡
            updateSelectedApiCount();
            
            // è®¾ç½®è¿‡æ»¤å™¨å¼€å…³çŠ¶æ€
            setupSettingsToggles();
        }

        // åˆå§‹åŒ–è®¾ç½®é¡µé¢çš„å¼€å…³çŠ¶æ€
        function setupSettingsToggles() {
            // é»„è‰²å†…å®¹è¿‡æ»¤å¼€å…³
            const yellowFilterToggle = document.getElementById('yellowFilterToggle');
            if (yellowFilterToggle) {
                const isYellowFilterEnabled = localStorage.getItem('yellowFilterEnabled') === 'true';
                yellowFilterToggle.checked = isYellowFilterEnabled;
                
                // è®¾ç½®åˆå§‹è§†è§‰çŠ¶æ€
                const yellowToggleBg = yellowFilterToggle.nextElementSibling;
                const yellowToggleDot = yellowToggleBg.nextElementSibling;
                if (isYellowFilterEnabled) {
                    yellowToggleBg.style.backgroundColor = '#667eea';
                    yellowToggleDot.style.transform = 'translateX(1.5rem)';
                } else {
                    yellowToggleBg.style.backgroundColor = '#6b7280';
                    yellowToggleDot.style.transform = 'translateX(0)';
                }
                
                yellowFilterToggle.addEventListener('change', function() {
                    const isChecked = this.checked;
                    localStorage.setItem('yellowFilterEnabled', isChecked ? 'true' : 'false');
                    
                    // æ›´æ–°è§†è§‰çŠ¶æ€
                    if (isChecked) {
                        yellowToggleBg.style.backgroundColor = '#667eea';
                        yellowToggleDot.style.transform = 'translateX(1.5rem)';
                    } else {
                        yellowToggleBg.style.backgroundColor = '#6b7280';
                        yellowToggleDot.style.transform = 'translateX(0)';
                    }
                    
                    // é‡æ–°åˆå§‹åŒ–APIå¤é€‰æ¡†ä»¥æ˜¾ç¤º/éšè—æˆäººå†…å®¹
                    initAPICheckboxes();
                });
            }

            // å¹¿å‘Šè¿‡æ»¤å¼€å…³
            const adFilterToggle = document.getElementById('adFilterToggle');
            if (adFilterToggle) {
                const isAdFilterEnabled = localStorage.getItem('adFilteringEnabled') !== 'false';
                adFilterToggle.checked = isAdFilterEnabled;
                
                // è®¾ç½®åˆå§‹è§†è§‰çŠ¶æ€
                const adToggleBg = adFilterToggle.nextElementSibling;
                const adToggleDot = adToggleBg.nextElementSibling;
                if (isAdFilterEnabled) {
                    adToggleBg.style.backgroundColor = '#667eea';
                    adToggleDot.style.transform = 'translateX(1.5rem)';
                } else {
                    adToggleBg.style.backgroundColor = '#6b7280';
                    adToggleDot.style.transform = 'translateX(0)';
                }
                
                adFilterToggle.addEventListener('change', function() {
                    const isChecked = this.checked;
                    localStorage.setItem('adFilteringEnabled', isChecked ? 'true' : 'false');
                    
                    // æ›´æ–°è§†è§‰çŠ¶æ€
                    if (isChecked) {
                        adToggleBg.style.backgroundColor = '#667eea';
                        adToggleDot.style.transform = 'translateX(1.5rem)';
                    } else {
                        adToggleBg.style.backgroundColor = '#6b7280';
                        adToggleDot.style.transform = 'translateX(0)';
                    }
                });
            }

            // è±†ç“£çƒ­é—¨å¼€å…³
            const doubanToggle = document.getElementById('doubanToggle');
            if (doubanToggle) {
                const isDoubanEnabled = localStorage.getItem('doubanEnabled') === 'true';
                doubanToggle.checked = isDoubanEnabled;
                
                // è®¾ç½®åˆå§‹è§†è§‰çŠ¶æ€
                const doubanToggleBg = doubanToggle.nextElementSibling;
                const doubanToggleDot = doubanToggleBg.nextElementSibling;
                if (isDoubanEnabled) {
                    doubanToggleBg.style.backgroundColor = '#667eea';
                    doubanToggleDot.style.transform = 'translateX(1.5rem)';
                } else {
                    doubanToggleBg.style.backgroundColor = '#6b7280';
                    doubanToggleDot.style.transform = 'translateX(0)';
                }
                
                doubanToggle.addEventListener('change', function() {
                    const isChecked = this.checked;
                    localStorage.setItem('doubanEnabled', isChecked ? 'true' : 'false');
                    
                    // æ›´æ–°è§†è§‰çŠ¶æ€
                    if (isChecked) {
                        doubanToggleBg.style.backgroundColor = '#667eea';
                        doubanToggleDot.style.transform = 'translateX(1.5rem)';
                    } else {
                        doubanToggleBg.style.backgroundColor = '#6b7280';
                        doubanToggleDot.style.transform = 'translateX(0)';
                    }
                });
            }
        }

        // ç®€åŒ–çš„APIç«™ç‚¹é…ç½®
        const API_SITES = {
            tyyszy: { name: "å¤©ç¿¼äº‘", url: "https://tyyszy.com/", adult: false },
            bfzy: { name: "æš´é£", url: "https://bfyszy.com/", adult: false },
            dyttzy: { name: "ç”µå½±å¤©å ‚", url: "https://www.dy6080.tv/", adult: false },
            ruyi: { name: "å¦‚æ„", url: "https://www.ruyizy.com/", adult: false }
        };

        // åˆå§‹åŒ–APIå¤é€‰æ¡†
        function initAPICheckboxes() {
            const container = document.getElementById('apiCheckboxes');
            if (!container) return;
            
            container.innerHTML = '';

            // è·å–å·²é€‰æ‹©çš„API
            let selectedAPIs = JSON.parse(localStorage.getItem('selectedAPIs') || '["tyyszy","dyttzy", "bfzy", "ruyi"]');

            // åˆ›å»ºæ™®é€šAPIæºçš„å¤é€‰æ¡†
            Object.keys(API_SITES).forEach(apiKey => {
                const api = API_SITES[apiKey];
                if (api.adult) return; // æš‚æ—¶è·³è¿‡æˆäººå†…å®¹

                const checked = selectedAPIs.includes(apiKey);

                const checkbox = document.createElement('div');
                checkbox.className = 'flex items-center mb-2';
                checkbox.innerHTML = `
                    <input type="checkbox" id="api_${apiKey}" 
                           class="form-checkbox h-4 w-4 text-blue-500" 
                           ${checked ? 'checked' : ''} 
                           data-api="${apiKey}">
                    <label for="api_${apiKey}" class="ml-2 text-sm text-white">${api.name}</label>
                `;
                container.appendChild(checkbox);

                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                checkbox.querySelector('input').addEventListener('change', function() {
                    updateSelectedAPIs();
                });
            });
        }

        // æ›´æ–°é€‰ä¸­çš„APIåˆ—è¡¨
        function updateSelectedAPIs() {
            const checkboxes = document.querySelectorAll('#apiCheckboxes input[type="checkbox"]');
            const selected = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.dataset.api);
                }
            });
            
            localStorage.setItem('selectedAPIs', JSON.stringify(selected));
            updateSelectedApiCount();
        }

        // æ›´æ–°é€‰ä¸­APIæ•°é‡æ˜¾ç¤º
        function updateSelectedApiCount() {
            const selectedAPIs = JSON.parse(localStorage.getItem('selectedAPIs') || '[]');
            const countElement = document.getElementById('selectedApiCount');
            if (countElement) {
                countElement.textContent = selectedAPIs.length;
            }
        }

        // å…¨é€‰/å…¨ä¸é€‰API
        function selectAllAPIs(selectAll = true, excludeAdult = false) {
            const checkboxes = document.querySelectorAll('#apiCheckboxes input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            
            updateSelectedAPIs();
        }

        // æ¸²æŸ“è‡ªå®šä¹‰APIåˆ—è¡¨
        function renderCustomAPIsList() {
            const container = document.getElementById('customApisList');
            if (!container) return;

            const customAPIs = JSON.parse(localStorage.getItem('customAPIs') || '[]');
            
            if (customAPIs.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">æš‚æ— è‡ªå®šä¹‰API</div>';
                return;
            }

            container.innerHTML = customAPIs.map((api, index) => `
                <div class="flex items-center justify-between p-2 bg-white bg-opacity-5 rounded mb-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="custom_api_${index}" 
                               class="form-checkbox h-4 w-4 text-blue-500 ${api.isAdult ? 'api-adult' : ''}" 
                               ${api.selected ? 'checked' : ''}>
                        <label for="custom_api_${index}" class="ml-2 text-sm ${api.isAdult ? 'text-pink-300' : 'text-white'}">
                            ${api.name}
                        </label>
                    </div>
                    <button onclick="removeCustomApi(${index})" class="text-red-400 hover:text-red-300 text-sm">åˆ é™¤</button>
                </div>
            `).join('');

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            customAPIs.forEach((api, index) => {
                const checkbox = document.getElementById(`custom_api_${index}`);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        customAPIs[index].selected = this.checked;
                        localStorage.setItem('customAPIs', JSON.stringify(customAPIs));
                        updateSelectedApiCount();
                    });
                }
            });
        }

        // æ˜¾ç¤ºæ·»åŠ è‡ªå®šä¹‰APIè¡¨å•
        function showAddCustomApiForm() {
            const form = document.getElementById('addCustomApiForm');
            if (form) {
                form.classList.remove('hidden');
            }
        }

        // å–æ¶ˆæ·»åŠ è‡ªå®šä¹‰API
        function cancelAddCustomApi() {
            const form = document.getElementById('addCustomApiForm');
            if (form) {
                form.classList.add('hidden');
                // æ¸…ç©ºè¡¨å•
                document.getElementById('customApiName').value = '';
                document.getElementById('customApiUrl').value = '';
                document.getElementById('customApiDetail').value = '';
                document.getElementById('customApiIsAdult').checked = false;
            }
        }

        // æ·»åŠ è‡ªå®šä¹‰API
        function addCustomApi() {
            const name = document.getElementById('customApiName').value.trim();
            const url = document.getElementById('customApiUrl').value.trim();
            const detail = document.getElementById('customApiDetail').value.trim();
            const isAdult = document.getElementById('customApiIsAdult').checked;

            if (!name || !url) {
                alert('è¯·å¡«å†™APIåç§°å’ŒURL');
                return;
            }

            const customAPIs = JSON.parse(localStorage.getItem('customAPIs') || '[]');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (customAPIs.some(api => api.name === name || api.url === url)) {
                alert('è¯¥APIå·²å­˜åœ¨');
                return;
            }

            customAPIs.push({
                name,
                url,
                detail: detail || url,
                isAdult,
                selected: true
            });

            localStorage.setItem('customAPIs', JSON.stringify(customAPIs));
            renderCustomAPIsList();
            cancelAddCustomApi();
            updateSelectedApiCount();
        }

        // åˆ é™¤è‡ªå®šä¹‰API
        function removeCustomApi(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰APIå—ï¼Ÿ')) return;

            const customAPIs = JSON.parse(localStorage.getItem('customAPIs') || '[]');
            customAPIs.splice(index, 1);
            localStorage.setItem('customAPIs', JSON.stringify(customAPIs));
            renderCustomAPIsList();
            updateSelectedApiCount();
        }

        // å¯¼å…¥é…ç½®
        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        
                        // éªŒè¯é…ç½®æ ¼å¼
                        if (config.selectedAPIs) {
                            localStorage.setItem('selectedAPIs', JSON.stringify(config.selectedAPIs));
                        }
                        if (config.customAPIs) {
                            localStorage.setItem('customAPIs', JSON.stringify(config.customAPIs));
                        }
                        if (config.yellowFilterEnabled !== undefined) {
                            localStorage.setItem('yellowFilterEnabled', config.yellowFilterEnabled.toString());
                        }
                        if (config.adFilteringEnabled !== undefined) {
                            localStorage.setItem('adFilteringEnabled', config.adFilteringEnabled.toString());
                        }
                        if (config.doubanEnabled !== undefined) {
                            localStorage.setItem('doubanEnabled', config.doubanEnabled.toString());
                        }

                        alert('é…ç½®å¯¼å…¥æˆåŠŸï¼');
                        loadSettings(); // é‡æ–°åŠ è½½è®¾ç½®
                    } catch (err) {
                        console.error('å¯¼å…¥é…ç½®å¤±è´¥:', err);
                        alert('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            const config = {
                selectedAPIs: JSON.parse(localStorage.getItem('selectedAPIs') || '[]'),
                customAPIs: JSON.parse(localStorage.getItem('customAPIs') || '[]'),
                yellowFilterEnabled: localStorage.getItem('yellowFilterEnabled') === 'true',
                adFilteringEnabled: localStorage.getItem('adFilteringEnabled') !== 'false',
                doubanEnabled: localStorage.getItem('doubanEnabled') === 'true',
                exportTime: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `libretv-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ¸…é™¤localStorage
        function clearLocalStorage() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰è®¾ç½®å’Œå†å²è®°å½•ã€‚')) return;
            
            localStorage.clear();
            alert('ç¼“å­˜å·²æ¸…é™¤');
            loadSettings(); // é‡æ–°åŠ è½½è®¾ç½®
        }
    </script>
</body>
</html>